<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>PDF Comparator - Drop and Compare</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
    }
    h1 {
      text-align: center;
    }
    #dropzone {
      border: 3px dashed #999;
      border-radius: 10px;
      padding: 50px;
      text-align: center;
      background: #f9f9f9;
      color: #666;
      font-size: 18px;
      margin-bottom: 20px;
    }
    #dropzone.dragover {
      background: #e6f7ff;
      border-color: #00aaff;
    }
    #compareBtn {
      display: none;
      margin: 20px auto;
      padding: 10px 20px;
      font-size: 16px;
      display: block;
      cursor: pointer;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 30px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 10px;
    }
    th { background: #f0f0f0; }
    .match { background-color: #e6ffe6; }
    .diff { background-color: #ffe6e6; }
  </style>
</head>
<body>

  <h1>Drop Two PDFs to Compare</h1>
  <div id="dropzone">Drop exactly 2 PDF files here</div>

  <button id="compareBtn">Compare Files</button>

  <table id="resultTable" style="display:none">
    <thead>
      <tr>
        <th>Field</th>
        <th>File 1</th>
        <th>File 2</th>
        <th>Comparison</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    let file1 = null, file2 = null;
    let text1 = '', text2 = '';

    const dropzone = document.getElementById('dropzone');
    const compareBtn = document.getElementById('compareBtn');

    dropzone.addEventListener('dragover', e => {
      e.preventDefault();
      dropzone.classList.add('dragover');
    });

    dropzone.addEventListener('dragleave', () => {
      dropzone.classList.remove('dragover');
    });

    dropzone.addEventListener('drop', async e => {
      e.preventDefault();
      dropzone.classList.remove('dragover');
      const files = [...e.dataTransfer.files].filter(f => f.type === 'application/pdf');

      if (files.length !== 2) {
        alert("Drop exactly TWO PDF files.");
        return;
      }

      [file1, file2] = files;
      dropzone.textContent = `Files loaded: ${file1.name} & ${file2.name}`;
      compareBtn.style.display = 'block';
    });

    compareBtn.addEventListener('click', async () => {
      if (!file1 || !file2) return alert("Please drop two PDF files first.");

      text1 = await extractPDFText(file1);
      text2 = await extractPDFText(file2);

      const fields1 = extractFields(text1);
      const fields2 = extractFields(text2);

      compareFields(fields1, fields2);
    });

    async function extractPDFText(file) {
      const arrayBuffer = await file.arrayBuffer();
      const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
      let text = '';
      for (let i = 1; i <= pdf.numPages; i++) {
        const page = await pdf.getPage(i);
        const content = await page.getTextContent();
        const strings = content.items.map(item => item.str);
        text += strings.join(' ') + '\n';
      }
      return text;
    }

    function extractFields(text) {
      const fields = {};
      const patterns = {
        'Shipper': /(\d{4}-\d{4} QUEBEC INC[\s\S]+?)\s+(STE|COTONOU|Same)/,
        'Consignee': /(STE WHITE LINE CO[\s\S]+?)\s+(SAME|EMAIL|COTONOU)/i,
        'Notify Party': /SAME AS CONSIGNEE/i,
        'Vessel': /MOMBASA EXPRESS\s+\w+/i,
        'Port of Loading': /PORT OF LOADING[:\s]*([A-Z,\s]+)/i,
        'Port of Discharge': /PORT OF DISCHARGE[:\s]*([A-Z,\s]+)/i,
        'VINs': /(VIN\s*#.*?)(?=\s+\w{3,}|$)/g,
        'CERS': /CERS[\s#:]*([A-Z0-9]+)/i,
        'ECTN': /ECTN[\s#:]*([A-Z0-9]+)/i,
        'Weight': /(Weight|Gross Weight)[^:\n]*[:\s]+([\d,.]+\s*(Kg|KGM))/i,
        'Seal': /SEAL[:\s]*([A-Z0-9]+)/i
      };

      for (const key in patterns) {
        const regex = patterns[key];
        if (key === 'VINs') {
          const vins = [...text.matchAll(regex)].map(m => m[1].trim());
          fields[key] = vins;
        } else {
          const match = text.match(regex);
          if (match) fields[key] = match[1].trim();
        }
      }

      return fields;
    }

    function compareFields(f1, f2) {
      const keys = new Set([...Object.keys(f1), ...Object.keys(f2)]);
      const table = document.querySelector("#resultTable");
      const tbody = table.querySelector("tbody");
      tbody.innerHTML = "";

      for (const key of keys) {
        const val1 = Array.isArray(f1[key]) ? f1[key].join(", ") : (f1[key] || '');
        const val2 = Array.isArray(f2[key]) ? f2[key].join(", ") : (f2[key] || '');

        const match = val1 === val2;
        const status = match ? 'Same' : 'Different';
        const className = match ? 'match' : 'diff';

        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${key}</td>
          <td class="${className}">${val1}</td>
          <td class="${className}">${val2}</td>
          <td class="${className}">${status}</td>
        `;
        tbody.appendChild(row);
      }

      table.style.display = 'table';
    }
  </script>

</body>
</html>
