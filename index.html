<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>PDF Comparison Tool</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    h2 { text-align: center; }
    #dropzone {
      border: 3px dashed #ccc;
      padding: 40px;
      text-align: center;
      border-radius: 10px;
      background: #f9f9f9;
      color: #555;
      margin-bottom: 20px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 10px;
    }
    th { background: #eee; }
    .match { background: #e6ffe6; }
    .diff { background: #ffe6e6; }
  </style>
</head>
<body>

<h2>Drop Exactly 2 PDF Files</h2>
<div id="dropzone">Drop your 2 PDF files here</div>

<table id="resultTable" style="display: none;">
  <thead>
    <tr><th>Field</th><th>File 1</th><th>File 2</th><th>Match?</th></tr>
  </thead>
  <tbody></tbody>
</table>

<script>
  let dropzone = document.getElementById('dropzone');

  dropzone.addEventListener('dragover', e => {
    e.preventDefault();
    dropzone.style.background = '#e0f7fa';
  });

  dropzone.addEventListener('dragleave', () => {
    dropzone.style.background = '#f9f9f9';
  });

  dropzone.addEventListener('drop', async e => {
    e.preventDefault();
    dropzone.style.background = '#f9f9f9';

    const files = [...e.dataTransfer.files].filter(f => f.type === 'application/pdf');
    if (files.length !== 2) return alert("Please drop exactly two PDF files.");

    const [text1, text2] = await Promise.all([extractPDFText(files[0]), extractPDFText(files[1])]);
    const data1 = extractFields(text1);
    const data2 = extractFields(text2);
    compareFields(data1, data2);
  });

  async function extractPDFText(file) {
    const buffer = await file.arrayBuffer();
    const pdf = await pdfjsLib.getDocument({ data: buffer }).promise;
    let text = '';
    for (let i = 1; i <= pdf.numPages; i++) {
      const page = await pdf.getPage(i);
      const content = await page.getTextContent();
      text += content.items.map(item => item.str).join(' ') + '\n';
    }
    return text;
  }

  function extractFields(text) {
    const normalize = str => (str || '').toLowerCase().replace(/\s+/g, ' ').trim();
    const find = (pattern) => {
      const m = text.match(new RegExp(pattern, 'i'));
      return m ? normalize(m[1]) : '';
    };
    const VINs = [...text.matchAll(/VIN[:#\s]*([A-HJ-NPR-Z0-9]{17})/gi)].map(m => m[1].toUpperCase());

    return {
      Shipper: find(/(?:Shipper|EXPORTER)[\s:]*([\s\S]*?QUEBEC INC)/),
      Consignee: find(/STE WHITE LINE CO[\s\S]*?(?=Same|Email|COTONOU)/),
      Destination: find(/PORT OF DISCHARGE[:\s]*([A-Z ]+)/),
      Container: find(/CNT[:\s]*([A-Z0-9]+)/) || find(/FANU\s*([0-9]+)/),
      Seal: find(/SEAL[:\s]*([0-9A-Z]+)/),
      Weight: find(/(?:Gross Weight|Weight)[^\d]*([\d,.]+)/),
      VINs: VINs.sort().join(', ')
    };
  }

  function floatsClose(a, b, tol = 1) {
    const f1 = parseFloat((a || '0').replace(/,/g, ''));
    const f2 = parseFloat((b || '0').replace(/,/g, ''));
    return Math.abs(f1 - f2) < tol;
  }

  function compareFields(d1, d2) {
    const table = document.getElementById("resultTable");
    const tbody = table.querySelector("tbody");
    tbody.innerHTML = '';
    table.style.display = 'table';

    for (const key in d1) {
      const val1 = d1[key];
      const val2 = d2[key];

      let match = false;
      if (key === 'Weight') match = floatsClose(val1, val2);
      else if (key === 'VINs') match = val1 === val2;
      else match = val1 === val2;

      const row = document.createElement("tr");
      row.innerHTML = `
        <td>${key}</td>
        <td class="${match ? 'match' : 'diff'}">${val1}</td>
        <td class="${match ? 'match' : 'diff'}">${val2}</td>
        <td class="${match ? 'match' : 'diff'}">${match ? '✅ Same' : '❌ Different'}</td>
      `;
      tbody.appendChild(row);
    }
  }
</script>

</body>
</html>
